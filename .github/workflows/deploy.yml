name: Deploy Synapse Workspace Artifacts

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    
    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Deploy using Azure CLI
      run: |
        # Update pipeline
        az synapse pipeline create --workspace-name externaldata \
          --name CPI_Universal_Ingestion \
          --file @pipeline/CPI_Universal_Ingestion.json
        
        # Update notebook
        az synapse notebook create --workspace-name externaldata \
          --name FRED_CPI_Full_Collection \
          --file @notebook/FRED_CPI_Full_Collection.json \
          --spark-pool-name spack2
        
        # Update linked service
        az synapse linked-service create --workspace-name externaldata \
          --name ADXLinkedService \
          --file @linkedService/ADXLinkedService.json
